if(!window.Funnelback)window.Funnelback={};if(!Element.prototype.matches){Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector}if(!Element.prototype.closest){Element.prototype.closest=function(s){var el=this;do{if(el.matches(s))return el;el=el.parentElement||el.parentNode}while(el!==null&&el.nodeType===1);return null}}if(!Object.entries){Object.entries=function(obj){var ownProps=Object.keys(obj),i=ownProps.length,resArray=new Array(i);while(i--)resArray[i]=[ownProps[i],obj[ownProps[i]]];return resArray}}window.Funnelback.SessionCart=function(){"use strict";var Constructor=function(options){return this.init(options)};Constructor.defaults={apiBase:"/",collection:null,iconPrefix:"glyphicon glyphicon-",cart:{selector:"#search-cart",pageSelector:["#search-results-content","#search-history"],icon:"pushpin",label:"Saved",backIcon:"arrow-left",backLabel:"Back to results",clearClasses:"btn btn-xs btn-danger",clearIcon:"remove",clearLabel:"Clear",templateSelector:"#cart-template",emptyMessage:'<span id="flb-cart-empty-message">No items</span>'},cartCount:{selector:".flb-cart-count",icon:"shopping-cart",isLabel:false,label:"cart",template:"{{>icon-block}} {{>label-block}} {{>badge-block}}"},item:{selector:"#search-results",templates:{default:'<h4><a href="{{indexUrl}}">{{#truncate 70}}{{title}}{{/truncate}}</a></h4><cite class="text-success">{{#cut "https://"}}{{indexUrl}}{{/cut}}</cite><p>{{#truncate 255}}{{summary}}{{/truncate}}</p>'},class:""},itemTrigger:{selector:"h4",position:"afterbegin",class:"",iconAdd:"pushpin",iconDelete:"remove",isLabel:false,labelAdd:"Add to cart",labelDelete:"Remove from cart",template:"{{>icon-block}} {{>label-block}}"},cartItemTrigger:{},resultItemTrigger:{}};Constructor.prototype.Handlebars=Handlebars.create();Constructor.prototype.init=function(options){if(!options.collection){console.error('Missing "collection" parameter');return null}Constructor.options=Utils.extend(Constructor.defaults,options||{});if(!Constructor.options.cart.pageSelector)Constructor.options.cart.pageSelector=[];Constructor.options.cartItemTrigger=Utils.extend(Utils.extend({},Constructor.options.itemTrigger),Constructor.options.cartItemTrigger);Constructor.options.resultItemTrigger=Utils.extend(Utils.extend({},Constructor.options.itemTrigger),Constructor.options.resultItemTrigger);CartBox.init(Constructor.options);CartCount.init(Constructor.options);Item.init(Constructor.options);ItemTrigger.init(Constructor.options);Items.set(Constructor.options);Api.get(Constructor.options).then((function(response){Items.update(Constructor.options,response.data);CartCount.set(response.data.length);CartBox.toggleClearElement(response.data)})).catch((function(error){console.error("Something went wrong and no data was fetched. Try again later..",error)}));return this};Constructor.prototype.clear=function(){if(confirm("Your selection will be cleared")===true){const options=this.getOption();Api.delete(options).then((function(response){Items.clear(options);CartCount.set(response.data.length);CartBox.toggleClearElement(response.data);Constructor.prototype.hide()})).catch((function(error){console.error("Something went wrong and cart was not cleared. Try again later..",error)}))}return this};Constructor.prototype.destroy=function(){Constructor.options={};return null};Constructor.prototype.show=function(){CartBox.element.style.display="block";CartBox.togglePageElements("none");CartBox.isHidden=false;return this};Constructor.prototype.hide=function(){CartBox.element.style.display="none";CartBox.togglePageElements("block");CartBox.isHidden=true;return this};Constructor.prototype.toggle=function(){return CartBox.isHidden?Constructor.prototype.show():Constructor.prototype.hide()};Constructor.prototype.getOption=function(key){if(arguments.length===0){return Constructor.options}if(typeof key==="string"){return Constructor.options[key]}};Constructor.prototype.addItem=function(url){const options=this.getOption();Api.post(options,{url:url}).then((function(response){Item.update(options,response.data.filter((function(it){return it.indexUrl===url}))[0],"del");CartCount.set(response.data.length);CartBox.toggleClearElement(response.data)})).catch((function(error){console.error("Something went wrong and item was not saved in a cart. Try again later..",error)}))};Constructor.prototype.deleteItem=function(url){const options=this.getOption();Api.delete(options,{url:url}).then((function(response){Item.update(options,{indexUrl:url},"add");CartCount.set(response.data.length);CartBox.toggleClearElement(response.data)})).catch((function(error){console.error("Something went wrong and result was not removed from a cart. Try again later..",error)}))};const Api={urlPath:"s/cart.json",delete:function(options,params){return Api.request("delete",options,params)},get:function(options,params){return Api.request("get",options,params)},post:function(options,params){return Api.request("post",options,params)},request:function(method,options,params){return new Promise((function(resolve,reject){const xhr=new XMLHttpRequest,url=Api.getUrl(options,params);xhr.withCredentials=true;xhr.onload=function(){if(this.status!==200){reject({url:url,error:this})}else{try{const data=JSON.parse(this.responseText);resolve({url:url,data:data})}catch(error){reject({url:url,error:error})}}};xhr.onerror=function(){reject({url:url,error:xhr})};xhr.open(method,url,true);xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","text/plain");xhr.send(JSON.stringify(params||{}))}))},getParamsString:function(params){const str=[];for(var p in params){if(params.hasOwnProperty(p))str.push(encodeURIComponent(p)+"="+encodeURIComponent(params[p]))}return str.join("&")},getUrl:function(options,params){if(!params)params={};params["collection"]=options.collection;return options.apiBase+Api.urlPath+"?"+Api.getParamsString(params)}};const CartBox={element:null,clearElement:null,listElement:null,pageElements:[],modifiedPageElements:null,isHidden:true,emptyMessage:null,init:function(options){CartBox.element=ElementUtil.findOnce(options.cart.selector);if(!CartBox.element)console.warn(`No element was found with provided selector "${options.cart.selector}"`);CartBox.element.style.display="none";CartBox.emptyMessage=options.cart.emptyMessage;for(var i=0,len=options.cart.pageSelector.length;i<len;i++){const el=ElementUtil.findOnce(options.cart.pageSelector[i]);if(el)CartBox.pageElements.push(el)}if(!CartBox.pageElements.length)console.warn(`No element was found with provided page selector "${options.cart.pageSelector}"`);const backIcon=options.cart.backIcon?options.iconPrefix+options.cart.backIcon:null;const headerIcon=options.cart.icon?options.iconPrefix+options.cart.icon:null;const clearIcon=options.cart.clearIcon?options.iconPrefix+options.cart.clearIcon:null;if(!document.querySelector(options.cart.templateSelector)){console.warn(`No element was found with the provided selector "${options.cart.templateSelector}"`)}const template=HandlebarsUtil.compile(document.querySelector(options.cart.templateSelector).text);document.getElementById("search-cart").innerHTML=template({backIcon:backIcon,headerIcon:headerIcon,clearIcon:clearIcon,backLabel:options.cart.backLabel,label:options.cart.label,clearLabel:options.cart.clearLabel});CartBox.clearElement=document.getElementById("flb-cart-box-clear");CartBox.clearElement.addEventListener("click",(function(){Constructor.prototype.clear(options)}));document.getElementById("flb-cart-box-back").addEventListener("click",Constructor.prototype.hide);CartBox.listElement=document.getElementById("flb-cart-box-list")},toggleClearElement:function(data){if(data.length>0){CartBox.clearElement.style.display="inline-block"}else{CartBox.listElement.innerHTML=CartBox.emptyMessage;CartBox.clearElement.style.display="none"}},togglePageElements:function(display){if(!CartBox.modifiedPageElements||display==="none"){CartBox.modifiedPageElements=CartBox.pageElements}const newlyModifiedElements=[];for(var i=0,len=CartBox.pageElements.length;i<len;i++){const elToConsider=CartBox.pageElements[i];if(CartBox.modifiedPageElements.indexOf(elToConsider)!==-1){if(elToConsider.style.display!==display){elToConsider.style.display=display;newlyModifiedElements.push(elToConsider)}}}CartBox.modifiedPageElements=newlyModifiedElements}};const CartCount={selector:"flb-cart-count-trigger",element:null,icon:null,label:null,partialTitle:" items",template:null,init:function(options){if(options.cartCount.icon)CartCount.icon=options.iconPrefix+options.cartCount.icon;if(options.cartCount.isLabel)CartCount.label=options.cartCount.label;if(options.cartCount.label)CartCount.partialTitle+=" in your "+options.cartCount.label.toLowerCase();CartCount.template=HandlebarsUtil.compile(options.cartCount.template);CartCount.element=ElementUtil.create(CartCount.selector,ElementUtil.findOnce(options.cartCount.selector),"button",CartCount.template(CartCount.data(0)),{class:"btn-link",type:"button",tabindex:"0",title:CartCount.title(0)});ElementUtil.addEvent(CartCount.element,"click",Constructor.prototype.toggle)},data:function(count){return{count:count,icon:CartCount.icon,label:CartCount.label}},set:function(count){ElementUtil.setContent(CartCount.element,CartCount.template(CartCount.data(count)));CartCount.element.setAttribute("title",CartCount.title(count));if(count===0){CartCount.element.closest("button").setAttribute("disabled","true")}},title:function(count){return count+CartCount.partialTitle}};const Item={selectorAttr:"data-fb-result",listElement:null,templates:null,init:function(options){Item.templates=Object.entries(options.item.templates).reduce((function(templates,[collection,template]){templates[collection]=HandlebarsUtil.compile(template);return templates}));Item.listElement=ElementUtil.findOnce(options.item.selector);if(!Item.listElement)console.warn('No element was found with provided selector "'+options.item.selector+'"')},selector:function(url){return url?"["+Item.selectorAttr+'="'+url+'"]':"["+Item.selectorAttr+"]"},update:function(options,data,action){const itemTrigger=ElementUtil.findOnce(Item.selector(data.indexUrl),Item.listElement);if(itemTrigger)ItemTrigger.update("result",itemTrigger,action);if(action==="add"){const cartItem=ElementUtil.findOnce(Item.selector(data.indexUrl),CartBox.listElement);ElementUtil.remove(cartItem)}else{const attributes={};if(options.item.class)attributes.class=options.item.class;attributes[Item.selectorAttr]=data.indexUrl;const template=Item.templates[data.collection]?Item.templates[data.collection]:Item.templates.default;const cartItem=ElementUtil.create("flb-cart-box-item",null,"li",template(data),attributes);ItemTrigger.set("cart",options.cartItemTrigger,cartItem);ItemTrigger.update("cart",cartItem);const emptyMessage=document.getElementById("flb-cart-empty-message");if(emptyMessage){emptyMessage.parentNode.removeChild(emptyMessage)}CartBox.listElement.insertAdjacentElement("afterbegin",cartItem)}}};const Items={clear:function(options){CartBox.listElement.innerHTML=CartBox.emptyMessage;const items=ElementUtil.find(Item.selector(),Item.listElement);for(var i=0,len=items.length;i<len;i++)ItemTrigger.update("result",items[i],"add")},set:function(options){const items=ElementUtil.find(Item.selector(),Item.listElement);for(var i=items.length-1;i>=0;i--)ItemTrigger.set("result",options.resultItemTrigger,items[i])},update:function(options,data,action){for(var i=0,len=data.length;i<len;i++)Item.update(options,data[i],action);if(!data.length)CartBox.listElement.innerHTML=CartBox.emptyMessage}};const ItemTrigger={selector:"flb-cart-item-trigger",addEvent:null,delEvent:null,cartAddTemplate:null,cartAddTitle:null,cartDelTemplate:null,cartDelTitle:null,resultAddTemplate:null,resultAddTitle:null,resultDelTemplate:null,resultDelTitle:null,init:function(options){setTrigger("cart",options.cartItemTrigger);setTrigger("result",options.resultItemTrigger);ItemTrigger.addEvent=function(e){e.preventDefault();const item=e.currentTarget.closest(Item.selector()),url=item.getAttribute(Item.selectorAttr);if(url)return Constructor.prototype.addItem(url);else console.warn("No URL found to save item in a cart")};ItemTrigger.delEvent=function(e){e.preventDefault();const item=e.currentTarget.closest(Item.selector()),url=item.getAttribute(Item.selectorAttr);if(url)return Constructor.prototype.deleteItem(url);else console.warn("No URL found to remove result from a cart")};function setTrigger(type,trigger){const template=HandlebarsUtil.compile(trigger.template);ItemTrigger[type+"AddTemplate"]=template({icon:options.iconPrefix+trigger.iconAdd,label:trigger.isLabel?trigger.labelAdd:null});ItemTrigger[type+"DelTemplate"]=template({icon:options.iconPrefix+trigger.iconDelete,label:trigger.isLabel?trigger.labelDelete:null});ItemTrigger[type+"AddTitle"]=trigger.labelAdd;ItemTrigger[type+"DelTitle"]=trigger.labelDelete}},set:function(type,trigger,item){const el=ElementUtil.findOnce(trigger.selector,item);const triggerEl=ElementUtil.create(ItemTrigger.selector,null,"button",ItemTrigger[type+"AddTemplate"],{class:trigger.class,title:ItemTrigger[type+"AddTitle"],type:"button",tabindex:"0"});ElementUtil.addEvent(triggerEl,"click",ItemTrigger.addEvent);if(el)el.insertAdjacentElement(trigger.position,triggerEl);else console.info('No element was found with provided selector "'+trigger.selector+'"')},update:function(type,item,action){const el=ElementUtil.findOnce("."+ItemTrigger.selector,item);if(action==="add"){ElementUtil.setContent(el,ItemTrigger[type+"AddTemplate"]);ElementUtil.removeEvent(el,"click",ItemTrigger.delEvent);ElementUtil.addEvent(el,"click",ItemTrigger.addEvent);el.setAttribute("title",ItemTrigger[type+"AddTitle"])}else{ElementUtil.setContent(el,ItemTrigger[type+"DelTemplate"]);ElementUtil.removeEvent(el,"click",ItemTrigger.addEvent);ElementUtil.addEvent(el,"click",ItemTrigger.delEvent);el.setAttribute("title",ItemTrigger[type+"DelTitle"])}}};const Templates={partial:{badge:'<span class="badge">{{count}}</span>',icon:'{{#if icon}}<span class="{{icon}} {{classes}} flb-cart-icon"></span>{{/if}}',label:"{{#if label}}{{label}}{{/if}}"},once:{iconLabel:"{{>icon-block}} {{>label-block}}"}};const ElementUtil={create:function(id,context,tag,content,attrs){const el=document.createElement(tag?tag:"div");if(content)ElementUtil.setContent(el,content);if(!attrs)attrs={};if(attrs["class"])attrs["class"]+=" "+id;else attrs["class"]=id;ElementUtil.setAttr(el,attrs);if(context)context.appendChild(el);return el},remove:function(element){if(!element){console.warn("Remove called on element which could not be found");return}element.parentNode.removeChild(element)},find:function(selector,context){if(!context)context=document;return context.querySelectorAll(selector)},findOnce:function(selector,context){return ElementUtil.find(selector,context)[0]},setAttr:function(element,attrs){const attrsArr=Object.entries(attrs);for(var i=0,len=attrsArr.length;i<len;i++)element.setAttribute(attrsArr[i][0],attrsArr[i][1])},setContent:function(element,content){element.innerHTML=content},addEvent:function(element,type,handler){element.addEventListener(type,handler)},removeEvent:function(element,type,handler){element.removeEventListener(type,handler)}};const Utils={extend:function(obj,src){for(var key in src){if(src.hasOwnProperty(key))obj[key]=typeof src[key]==="object"?Utils.extend(obj[key]||{},src[key]):src[key]}return obj}};const HandlebarsUtil={compile:function(template){return Constructor.prototype.Handlebars.compile(template)},registerPartial:function(templates){const templatesArr=Object.entries(templates);for(var i=0,len=templatesArr.length;i<len;i++)Constructor.prototype.Handlebars.registerPartial(templatesArr[i][0]+"-block",templatesArr[i][1])}};HandlebarsUtil.registerPartial(Templates.partial);Constructor.prototype.Handlebars.registerHelper({cut:function(toCut,options){const str=options.fn(this);if(str.indexOf(toCut)===0)return str.substring(toCut.length);return str},truncate:function(len,options){const str=options.fn(this);if(str&&str.length>len&&str.length>0){var new_str=str+" ";new_str=str.substr(0,len);new_str=str.substr(0,new_str.lastIndexOf(" "));new_str=new_str.length>0?new_str:str.substr(0,len);return new Constructor.prototype.Handlebars.SafeString(new_str+"...")}return str}});return Constructor}();